<template>
  <main>
    <div class="wrapper">
      <h1>Accessa Weather</h1>
      <AddLocation @add-location="handleAddLocation" />
      <LocationWeather
        v-for="forecast in forecasts"
        :forecast="forecast"
        :language="language"
        @delete-location="handleDeleteLocation"
      />
    </div>
  </main>
</template>

<script>
import GeolocationService from './services/GeolocationService';
import LanguageService from './services/LanguageService';
import WeatherService from './services/WeatherService';

import AddLocation from './components/AddLocation.vue';
import LocationWeather from './components/LocationWeather.vue';

const GeolocationServiceAPI = new GeolocationService();
const LanguageServiceAPI = new LanguageService();
const WeatherServiceAPI = new WeatherService();

export default {
  components: { AddLocation, LocationWeather },
  data() {
    return {
      language: null, // By default, user's browser language is used for getting initial forecast
      currentLocation: null, // By default, current user location is used for getting initial forecast
      forecasts: [], // Forecasts for each location, received from API
    };
  },
  methods: {
    getLocation() {
      GeolocationServiceAPI.getLocation((position) => {
        const location = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          acc: position.coords.accuracy,
          timestamp: position.timestamp,
        };
        this.currentLocation = location;
      });
    },
    getLanguage() {
      this.language = LanguageServiceAPI.language;
    },
    async getWeekForecast(location) {
      const weekForecast = await WeatherServiceAPI.getForecast(
        location,
        7,
        'forecast',
        this.language
      );
      this.forecasts.push(weekForecast);
    },
    handleAddLocation(location) {
      this.getWeekForecast(location);
    },
    handleDeleteLocation(locationName) {
      this.forecasts = this.forecasts.filter(
        (forecast) => forecast.location.name !== locationName
      );
    },
  },
  created() {
    this.getLocation();
    this.getLanguage();

    if (this.currentLocation) {
      const { lat, lng } = this.currentLocation;
      this.getWeekForecast(`${lat}, ${lng}`);
    }
  },
  watch: {
    currentLocation() {
      if (this.currentLocation) {
        const { lat, lng } = this.currentLocation;
        this.getWeekForecast(`${lat}, ${lng}`);
      }
    },
  },
};
</script>
